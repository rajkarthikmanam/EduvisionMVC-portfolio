name: Deploy to Azure App Service (Publish Profile)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  AZURE_WEBAPP_NAME: 'eduvision-app'  # Replace with your Azure App Service name

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore EduvisionMvc.csproj

    - name: Build project
      run: dotnet build EduvisionMvc.csproj --configuration Release --no-restore

    - name: Publish project
      run: dotnet publish EduvisionMvc.csproj -c Release -o ./publish

    - name: Update web.config for Production
      shell: pwsh
      run: |
        $webConfigPath = "publish/web.config"
        if (-not (Test-Path $webConfigPath)) { Write-Error "web.config not found in publish output"; exit 1 }
        [xml]$webConfig = Get-Content $webConfigPath
        $envVars = $webConfig.SelectSingleNode("//environmentVariables")
        if ($null -eq $envVars) { $aspNetCore = $webConfig.SelectSingleNode("//aspNetCore"); $envVars = $webConfig.CreateElement("environmentVariables"); $aspNetCore.AppendChild($envVars) | Out-Null }
        $envVar = $webConfig.SelectSingleNode("//environmentVariable[@name='ASPNETCORE_ENVIRONMENT']")
        if ($null -eq $envVar) { $envVar = $webConfig.CreateElement("environmentVariable"); $envVar.SetAttribute("name","ASPNETCORE_ENVIRONMENT"); $envVars.AppendChild($envVar) | Out-Null }
        $envVar.SetAttribute("value","Production")
        $aspNetCore = $webConfig.SelectSingleNode("//aspNetCore")
        $aspNetCore.SetAttribute("stdoutLogEnabled","true")
        $aspNetCore.SetAttribute("stdoutLogFile",".\\logs\\stdout")
        $webConfig.Save($webConfigPath)
        Write-Host "web.config updated for Production"

    - name: Create deployment package (zip)
      shell: pwsh
      run: |
        if (Test-Path publish.zip) { Remove-Item publish.zip -Force }
        Compress-Archive -Path "publish/*" -DestinationPath publish.zip -Force
        Write-Host "Created publish.zip"

    - name: Deploy to Azure Web App (Publish Profile)
      uses: azure/webapps-deploy@v2
      with:
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./publish.zip
    
    - name: Set Production environment variable via Azure CLI
      shell: pwsh
      run: |
        # Extract app name and credentials from publish profile
        [xml]$profile = [xml]'${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}'
        $publishData = $profile.publishData.publishProfile | Where-Object { $_.publishMethod -eq 'MSDeploy' } | Select-Object -First 1
        $appName = $publishData.msdeploySite
        $username = $publishData.userName
        $password = $publishData.userPWD
        
        # Use Kudu API to set app setting
        $base64Auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${username}:${password}"))
        $apiUrl = "https://${appName}.scm.azurewebsites.net/api/settings"
        
        $settings = @{
          ASPNETCORE_ENVIRONMENT = "Production"
        }
        
        try {
          Invoke-RestMethod -Uri $apiUrl -Method Post -Body ($settings | ConvertTo-Json) -Headers @{
            Authorization = "Basic $base64Auth"
            "Content-Type" = "application/json"
          }
          Write-Host "‚úÖ Set ASPNETCORE_ENVIRONMENT to Production via Kudu API"
        } catch {
          Write-Warning "Could not set environment variable via API (app may need manual configuration): $_"
        }

    - name: Deployment summary
      run: |
        echo "‚úÖ Deployment completed (Publish Profile)"
        echo "üîó App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo ""
        echo "‚ö†Ô∏è CRITICAL: Verify Azure App Service Configuration:"
        echo "1. Go to Azure Portal ‚Üí App Service ‚Üí Configuration ‚Üí Application settings"
        echo "   - ASPNETCORE_ENVIRONMENT should be 'Production' (not Development)"
        echo "2. Go to Configuration ‚Üí Connection strings"
        echo "   - DefaultConnection (Type: SQLAzure) should be your SQL Server connection string"
        echo "   - Example: Server=tcp:yourserver.database.windows.net,1433;Initial Catalog=yourdb;User ID=youradmin;Password=yourpass;Encrypt=True;TrustServerCertificate=False;"
        echo ""
        echo "3. After verifying/updating settings, restart the App Service"
        echo "4. Check Log Stream for migration errors"
