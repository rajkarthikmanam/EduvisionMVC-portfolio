name: Deploy to Azure App Service (Publish Profile)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  AZURE_WEBAPP_NAME: 'eduvision-app'  # Replace with your Azure App Service name

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore EduvisionMvc.csproj

    - name: Build project
      run: dotnet build EduvisionMvc.csproj --configuration Release --no-restore

    - name: Publish project
      run: dotnet publish EduvisionMvc.csproj -c Release -o ./publish

    - name: Update web.config for Production
      shell: pwsh
      run: |
        $webConfigPath = "publish/web.config"
        if (-not (Test-Path $webConfigPath)) { Write-Error "web.config not found in publish output"; exit 1 }
        [xml]$webConfig = Get-Content $webConfigPath
        $envVars = $webConfig.SelectSingleNode("//environmentVariables")
        if ($null -eq $envVars) { $aspNetCore = $webConfig.SelectSingleNode("//aspNetCore"); $envVars = $webConfig.CreateElement("environmentVariables"); $aspNetCore.AppendChild($envVars) | Out-Null }
        $envVar = $webConfig.SelectSingleNode("//environmentVariable[@name='ASPNETCORE_ENVIRONMENT']")
        if ($null -eq $envVar) { $envVar = $webConfig.CreateElement("environmentVariable"); $envVar.SetAttribute("name","ASPNETCORE_ENVIRONMENT"); $envVars.AppendChild($envVar) | Out-Null }
        $envVar.SetAttribute("value","Production")
        $aspNetCore = $webConfig.SelectSingleNode("//aspNetCore")
        $aspNetCore.SetAttribute("stdoutLogEnabled","true")
        $aspNetCore.SetAttribute("stdoutLogFile",".\\logs\\stdout")
        $webConfig.Save($webConfigPath)
        Write-Host "web.config updated for Production"

    - name: Create deployment package (zip)
      shell: pwsh
      run: |
        if (Test-Path publish.zip) { Remove-Item publish.zip -Force }
        Compress-Archive -Path "publish/*" -DestinationPath publish.zip -Force
        Write-Host "Created publish.zip"

    - name: Deploy to Azure Web App (Publish Profile)
      uses: azure/webapps-deploy@v2
      with:
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./publish.zip

    - name: Deployment summary
      run: |
        echo "‚úÖ Deployment completed (Publish Profile)"
        echo "üîó App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "‚û°Ô∏è Next: Verify connection string + migrations in Log Stream"
