name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Required for OIDC-based Azure login
permissions:
  id-token: write
  contents: read

env:
  DOTNET_VERSION: '9.0.x'
  AZURE_WEBAPP_NAME: 'eduvision-app'  # Replace with your Azure App Service name

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore EduvisionMvc.csproj

    - name: Build project
      run: dotnet build EduvisionMvc.csproj --configuration Release --no-restore

    - name: Publish project
      run: dotnet publish EduvisionMvc.csproj -c Release -o ./publish

    - name: Update web.config for Production
      shell: pwsh
      run: |
        $webConfigPath = "publish/web.config"
        [xml]$webConfig = Get-Content $webConfigPath
        
        # Find or create environmentVariables section
        $envVars = $webConfig.SelectSingleNode("//environmentVariables")
        if ($null -eq $envVars) {
          $aspNetCore = $webConfig.SelectSingleNode("//aspNetCore")
          $envVars = $webConfig.CreateElement("environmentVariables")
          $aspNetCore.AppendChild($envVars) | Out-Null
        }
        
        # Set Production environment
        $envVar = $webConfig.SelectSingleNode("//environmentVariable[@name='ASPNETCORE_ENVIRONMENT']")
        if ($null -eq $envVar) {
          $envVar = $webConfig.CreateElement("environmentVariable")
          $envVar.SetAttribute("name", "ASPNETCORE_ENVIRONMENT")
          $envVars.AppendChild($envVar) | Out-Null
        }
        $envVar.SetAttribute("value", "Production")
        
        # Enable stdout logging
        $aspNetCore = $webConfig.SelectSingleNode("//aspNetCore")
        $aspNetCore.SetAttribute("stdoutLogEnabled", "true")
        $aspNetCore.SetAttribute("stdoutLogFile", ".\logs\stdout")
        
        $webConfig.Save($webConfigPath)
        Write-Host "web.config updated for Production environment"

    - name: Azure login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ./publish

    - name: Deployment summary
      run: |
        echo "âœ… Deployment completed (OIDC)"
        echo "ðŸ“¦ Package includes migrations and Production web.config"
        echo "ðŸ”— App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "âž¡ï¸ Check Azure App Service -> Log stream for migration output"
